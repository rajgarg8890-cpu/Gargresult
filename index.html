<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { 
      background-color: #f0f2f5; 
      font-family: 'Segoe UI', sans-serif; 
      overflow-x: hidden;
      touch-action: pan-y;
    }
    .main-card { 
      max-width: 480px; 
      margin: 20px auto; 
      background: #fff; 
      border-radius: 15px; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
      padding: 25px; 
      border-top: 6px solid #001f3f; 
      position: relative;
      z-index: 1; 
    }
    .header-box { background: #001f3f; color: white; padding: 12px; text-align: center; border-radius: 8px; font-weight: bold; margin-bottom: 20px; }
    .data-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 15px; }
    .data-val { font-weight: bold; color: #000; text-align: right; }
    .marks-row { display: flex; justify-content: space-between; margin-top: 20px; gap: 10px; flex-wrap: wrap; }
    .mark-item { border: 2.5px solid #001f3f; border-radius: 12px; padding: 12px; text-align: center; flex: 1; min-width: 100px; background: #fcfcfc; }
    .mark-val { font-size: 26px; font-weight: 800; color: #d9534f; }
    .disclaimer { font-size: 11px; color: #777; border-top: 1px dashed #ccc; padding-top: 15px; margin-top: 20px; text-align: center; }
    .error-msg { color: #d9534f; background: #fdf2f2; padding: 12px; border-radius: 8px; display: none; margin-bottom: 15px; text-align: center; font-weight: bold; border: 1px solid #f5c6cb; }

    #hiddenDownloadArea { 
      position: fixed; 
      left: -5000px; 
      top: 0; 
      width: 600px; 
      background: white; 
      padding: 40px; 
      border: 1px solid #000; 
      pointer-events: none; 
      z-index: -100;
    }
    .dl-title { background: #001f3f; color: white; text-align: center; padding: 15px; font-size: 22px; font-weight: bold; margin-bottom: 5px; }
    .dl-exam { text-align: center; font-size: 16px; font-weight: bold; color: #333; margin-bottom: 20px; border-bottom: 2px solid #001f3f; padding-bottom: 5px; }
  </style>
</head>
<body>

<div class="container">
  <div id="searchPage" class="main-card">
    <h4 class="text-center mb-4" style="color: #001f3f; font-weight: 800;">Result Portal 2026</h4>
    <div id="customAlert" class="error-msg"></div>
    <div class="mb-3">
      <label class="form-label small fw-bold">SELECT EXAM</label>
      <select id="examSelect" class="form-select">
          <option value="">Loading Exams...</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label small fw-bold">ROLL NUMBER</label>
      <input type="text" id="rollNo" class="form-control" placeholder="Enter Roll Number">
    </div>
    <button id="searchBtn" onclick="checkResult()" class="btn btn-primary w-100 fw-bold" style="background:#001f3f; padding:12px;">GET SCORECARD</button>
    <div class="disclaimer">
      <p class="fw-bold mb-1">Result by Raj Garg</p>
      <p>Ye result official data se liya gaya hai. Kripya official result ke liye official website par check karein.</p>
    </div>
  </div>

  <div id="resultPage" class="main-card" style="display:none;">
    <button class="btn btn-sm btn-outline-secondary mb-3" onclick="goBack(false)">‚Üê Back to Search</button>
    <div id="portalDisplay"></div>
    <div class="mt-4 pt-3 border-top">
      <div class="d-flex gap-2">
        <select id="formatSelect" class="form-select">
          <option value="png">PNG</option>
          <option value="jpg">JPG</option>
          <option value="pdf">PDF</option>
        </select>
        <button id="dlBtn" class="btn btn-success fw-bold px-4" onclick="startDownload()">Download</button>
      </div>
    </div>
  </div>
</div>

<div id="hiddenDownloadArea">
    <div class="dl-title">CANDIDATE SCORECARD</div>
    <div id="dl_examName" class="dl-exam"></div>
    <div id="dl_details"></div>
    <div id="dl_marks" class="marks-row"></div>
    <div class="disclaimer">
      <p class="fw-bold mb-1" style="color:#000;">Result by Raj Garg</p>
      <p>Ye result official data se liya gaya hai. Kripya official result ke liye official website par check karein.</p>
    </div>
</div>

<script>
  // Aapki Updated Google Script URL
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbza1CacQIan-V032ole6IUIvQDjGhihhZy87k2ULxtRhb10j0sO3-WcG4cWogKvh6hu_A/exec";

  window.onload = function() {
    fetch(`${WEB_APP_URL}?action=getExams`)
      .then(res => res.json())
      .then(f => {
        let s = document.getElementById('examSelect');
        s.innerHTML = '<option value="">-- Choose Exam Name --</option>';
        f.forEach(x => { s.innerHTML += `<option value="${x.id}">${x.name}</option>`; });
      })
      .catch(err => showAlert("Error loading exams. Please refresh."));

    window.onpopstate = function() {
      if (document.getElementById('resultPage').style.display === "block") {
        goBack(true);
      }
    };
  };

  function showAlert(msg) {
    let a = document.getElementById('customAlert');
    a.innerText = msg; a.style.display = "block";
    resetSearchButton();
    setTimeout(() => a.style.display = "none", 5000);
  }

  function resetSearchButton() {
    let b = document.getElementById('searchBtn');
    b.disabled = false; b.innerText = "GET SCORECARD";
  }

  function checkResult() {
    let r = document.getElementById('rollNo').value.trim();
    let f = document.getElementById('examSelect');
    if(!f.value || !r) return showAlert("Select Exam & Enter Roll No");
    
    document.getElementById('searchBtn').disabled = true;
    document.getElementById('searchBtn').innerText = "Searching...";
    document.getElementById('dl_examName').innerText = f.options[f.selectedIndex].text;

    fetch(`${WEB_APP_URL}?action=getScorecard&rollNo=${r}&folderId=${f.value}`)
      .then(res => res.json())
      .then(displayResult)
      .catch(err => {
          resetSearchButton();
          showAlert("Connection Error!");
      });
  }

  function displayResult(d) {
    resetSearchButton();
    if(d == "Not Found") return showAlert("Roll Number Not Found!");
    
    history.pushState({page: 'result'}, "Result", "");
    document.getElementById('searchPage').style.display = "none";
    document.getElementById('resultPage').style.display = "block";
    window.scrollTo(0,0);

    let rows = ""; let marks = "";
    const order = ["Roll no", "Rank", "Merit", "Candidate Name", "Father Name", "Mother Name", "Category", "Gender"];
    
    order.forEach(k => { 
      if(d[k]) rows += `<div class="data-row"><div>${k}:</div><div class="data-val">${d[k]}</div></div>`; 
    });

    for(let k in d) {
      if((k.toLowerCase().includes("marks") || k.toLowerCase().includes("score") || k.toLowerCase().includes("total")) && !order.includes(k)) {
        marks += `<div class="mark-item"><div class="mark-val">${d[k]}</div><div class="small fw-bold uppercase">${k}</div></div>`;
      }
    }

    const discHtml = `<div class="disclaimer"><p class="fw-bold mb-1">Result by Raj Garg</p><p>Ye result official data se liya gaya hai. Kripya official result ke liye official website par check karein.</p></div>`;
    document.getElementById('portalDisplay').innerHTML = `<div class="header-box">EXAM RESULT</div>` + rows + `<div class="marks-row">${marks}</div>` + discHtml;
    document.getElementById('dl_details').innerHTML = rows;
    document.getElementById('dl_marks').innerHTML = marks;
  }

  function goBack(isHardwareBack) {
    document.getElementById('resultPage').style.display = "none";
    document.getElementById('searchPage').style.display = "block";
    resetSearchButton();
    if(!isHardwareBack) history.back();
  }

  function startDownload() {
    const format = document.getElementById('formatSelect').value;
    const capture = document.getElementById('hiddenDownloadArea');
    const btn = document.getElementById('dlBtn');
    
    btn.innerText = "Processing...";
    btn.disabled = true;

    html2canvas(capture, { 
      scale: 2, 
      useCORS: true,
      logging: false,
      removeContainer: true
    }).then(canvas => {
      btn.innerText = "Download";
      btn.disabled = false;
      const imgData = canvas.toDataURL('image/png');
      if(format === 'pdf') {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 190;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
        pdf.save("Scorecard.pdf");
      } else {
        let l = document.createElement('a');
        l.download = 'Scorecard.' + format;
        l.href = canvas.toDataURL("image/" + (format==='jpg'?'jpeg':'png'));
        l.click();
      }
    });
  }
</script>
</body>
</html>
